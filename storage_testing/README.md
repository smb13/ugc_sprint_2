# Задача
### Провести исследование по выбору хранилища.

* Выбрать хранилище для задачи.
  * Выбраны MongoDB и Posrgresql для сравнения
* Написать скрипт, который генерирует в хранилище данные.
  * Запуск `make first_start` поднимает сервисы хранилищ, создаёт базы данных Postgres и Mongo и заполняет их данными
* Измерить скорость добавления и чтения данных:
  * Тестирование чтения уже загруженных данных на кейсах:
    * Списки понравившихся пользователям фильмов (списки лайков пользователей)
    * Средняя пользовательская оценка фильма
  * Тестирование чтения данных, поступающих в реальном времени:
    * Добавление оценки пользователя и получение оценок этого пользователя
    * Добавление оценки к фильму и получение средней пользовательской оценки этого фильма
  * Запуск тестов осуществляется командой `make run_tests`

### Результаты тестирования

| Тест                                                        | Postgres run 1 | Postgres run 2 | Mongo run 1 | Mongo run 2 |
|-------------------------------------------------------------|----------------|----------------|-------------|-------------|
| Тестирование чтения уже загруженных данных                  |                |                |             |             |
| Списки понравившихся 10 000 пользователям фильмов           | 1.893 s        | 2.119 s        | 5.375       | 5.774 s     |
| Средняя пользовательская оценка 10 000 фильма               | 27.546 s       | 29.889 s       | 36.574 s    | 38.974 s    |
| Тестирование единичной вставки                              | 9.878 s        | 8.362 s        | 25.084 s    | 26.470 s    |
| Тестирование чтения данных, поступающих в реальном времени  |                |                |             |             |
| Добавление оценки пользователя и получение его оценок       | 11.940 s       | 10.996 s       | 28.143 s    | 31.025 s    |
| Добавление оценки к фильму и получение его средней оценки   | 39.048 s       | 42.254 s       | 60.282 s    | 66.969 s    |

Тестирование производилось на 10 млн строк одном шарже БД на ноутбуке Core i5 gen 11 с 16 Gb RAM и SSD
Для тестирования были созданы индексы:
* в Postgres создан уникальный индексы на первичный ключ (user_id, film_id) и доп индекс на film_id
* в Mongo созданы уникальный индекс на (user_id, film_id) и доп индексы на user_id и film_id 

Mongo DB поддерживает шардирование, что в отличие от Postgresql может ускорить работу в разы

### Выбрать способ реализации сервиса и описать причины выбора:

Требования к сервису отличаются от требований к сервису сбора аналитических данных
* Функциональные требования разные по определению, т.к. у сервисов разные задачи 
* Нефункциональные требования отличаются по следующим параметрам:

| Критерий                                                | Сервис аналитики                                                                          | Сервис лайков                                                                  |
|---------------------------------------------------------|-------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|
| Производительность (Средняя и максимальная нагрузка)    | Должна быть выше, т.к. используется во всех сценариях                                     | Может быть ниже, т.к. используется только по назначению                        |
| Время отклика на пользовательские запросы               | Может быть больше, т.к. данные передаются в фоновом режиме                                | Должно быть меньше, т.к. пользователь ожидает быстрой реакции на свои действия |
| Масштабирование                                         | Требования выше, т.к. могут подключаться новые сервисы                                    | Требования ниже, т.к. лайки и отзывы нужны только для фильмов                  |
| Безопасность                                            | Одинаково                                                                                 | Одинаково                                                                      |
| Надежность и доступность                                | Требования ниже, т.к. сбор данные не влияет на пользовательский опыт и потери не критичны | Требования выше, т.к. влияет на пользовательский опыт                          |

* Требования к хранилищу

| Критерий                               | Сервис аналитики                             | Сервис лайков                               |
|----------------------------------------|----------------------------------------------|---------------------------------------------|
| Скорость записи данных                 | Требования выше                              | Требования ниже                             |
| Возможность случайного чтения и записи | Отсутствует                                  | Необходима                                  | 
| Возможности аггрегации данных          | Сложные аггрегации и аналитические запросы   | Простые аггрегации (средний рейтинг фильма) | 

В связи с этим, решено разработать отдельный сервис для хранения лайков и закладок.
